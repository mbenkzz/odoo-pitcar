<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <!-- Inherit the project task form view to add "Entry Date" and "Invoice" -->
    <record id="view_task_form_inherit" model="ir.ui.view">
        <field name="name">project.task.form.inherit.entry_date_invoice</field>
        <field name="model">project.task</field>
        <field name="inherit_id" ref="project.view_task_form2"/>
        <field name="arch" type="xml">
            <xpath expr="//sheet/group" position="inside">
                <group>
                    <field name="entry_date"/>
                    <field name="invoice_id" 
                       domain="[('partner_id', '=', partner_id), ('state', '=', 'posted')]" 
                       options="{'no_create': True}"
                       attrs="{'invisible': [('partner_id', '=', False)]}"
                       context="{'display_invoice_origin': True}">
                        <tree>
                            <field name="name"/>
                            <field name="invoice_origin"/>
                            <field name="amount_total"/>
                            <field name="invoice_date"/>
                        </tree>
                    </field>
                </group>
            </xpath>
        </field>
    </record>

     <!-- Inherit the project task Kanban view to customize the card -->
    <record id="view_task_kanban_inherit" model="ir.ui.view">
        <field name="name">project.task.kanban.inherit.custom</field>
        <field name="model">project.task</field>
        <field name="inherit_id" ref="project.view_task_kanban"/>
        <field name="arch" type="xml">
            <!-- Customizing the Kanban card layout -->
            <xpath expr="//templates" position="replace">
                <templates>
                    <t t-name="kanban-box">
                        <div t-attf-class="oe_kanban_card oe_kanban_global_click">
                            <div class="oe_kanban_content">
                                

                                <!-- Title and Customer Info -->
                                <div class="o_kanban_record_top">
                                    <div class="o_kanban_record_headings">
                                        <strong class="o_kanban_record_title">
                                            <field name="name"/> <!-- Task Name -->
                                        </strong>
                                        <small class="o_kanban_record_subtitle text-muted">
                                            <field name="partner_id"/> <!-- Customer Name -->
                                        </small>
                                    </div>
                                </div>

                                <!-- Tags and Entry Date -->
                                <div class="o_kanban_record_body">
                                    <field name="tag_ids" widget="many2many_tags" options="{'color_field': 'color'}"/>
                                </div>

                                <!-- Deadline Date -->
                                <div class="o_kanban_record_body mb-2">
                                    <div>
                                        <span style="font-weight: 500;">Entry Date:</span> <field name="entry_date"/>
                                    </div>
                                    <div class="mb-2">
                                        <span style="font-weight: 500;">Deadline:</span> <field name="date_deadline"/>
                                    </div>

                                    <!-- Invoice Total (Updated for safety) -->
                                    <t t-if="record.invoice_total.value">
                                        <div class="o_kanban_record_top mb-2">
                                            <div class="o_kanban_record_headings d-flex justify-content-between align-items-center w-100">
                                                <strong class="text-primary">
                                                    Invoice Total: 
                                                    <field name="invoice_total" widget="monetary" options="{'currency_field': 'currency_id'}"/>
                                                </strong>
                                            </div>
                                        </div>
                                    </t>
                                </div>

                                <!-- Bottom Section with Priority, Timer, and Activities -->
                                <div class="o_kanban_record_bottom mt-2">
                                    <div class="oe_kanban_bottom_left">
                                        <!-- Priority Field -->
                                        <field name="priority" widget="priority"/>
                                        <!-- Activity -->
                                        <field name="activity_ids" widget="kanban_activity"/>
                                    </div>
                                    <div class="oe_kanban_bottom_right">
                                        <!-- Task State -->
                                        <field name="kanban_state" widget="state_selection"/> 
                                    </div>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </xpath>
        </field>
    </record>
</odoo>